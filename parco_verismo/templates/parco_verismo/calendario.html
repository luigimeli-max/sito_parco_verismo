{% extends "parco_verismo/base.html" %} {% load static i18n %} {% block title
%}{% trans 'Calendario Eventi - Parco Letterario Verismo' %}{% endblock %} {%
block hero_section %}{% endblock %} {% block content %}
<section class="container my-5 pt-5">
  <div class="text-center mb-5">
    <h1 class="display-4 fw-bold text-primary mb-3">
      <i class="bi bi-calendar-week me-3"></i>
      {% trans 'Calendario Eventi' %}
    </h1>
    <p class="lead text-secondary mb-0">
      {% trans 'Consulta il calendario completo degli eventi e salva i tuoi
      preferiti' %}
    </p>
  </div>

  <div class="row">
    <div class="col-lg-11 mx-auto">
      <!-- FullCalendar Container -->
      <div id="calendar"></div>
    </div>
  </div>
</section>

<!-- Modal per dettagli evento -->
<div class="modal fade" id="eventoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0" style="box-shadow: var(--shadow-lg)">
      <div
        class="modal-header"
        style="
          background: var(--color-primary);
          color: var(--color-text-inverse);
          border-bottom: none;
        "
      >
        <h5 class="modal-title fw-semibold" id="eventoModalTitle">
          <i class="bi bi-calendar-event me-2"></i>
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body p-4" id="eventoModalBody">
        <!-- Contenuto dinamico -->
      </div>
      <div class="modal-footer border-top-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          {% trans 'Chiudi' %}
        </button>
        <a href="#" id="eventoDetailLink" class="btn btn-primary">
          <i class="bi bi-info-circle me-1"></i>{% trans 'Vedi dettagli
          completi' %}
        </a>
      </div>
    </div>
  </div>
</div>

<style>
  /* ========================================================
   OVERRIDE BOOTSTRAP - FORZA PALETTE DEL SITO
   ======================================================== */

  .text-primary {
    color: var(--color-primary) !important;
  }

  .btn-outline-primary {
    --bs-btn-color: var(--color-primary);
    --bs-btn-border-color: var(--color-primary);
    --bs-btn-hover-bg: var(--color-primary);
    --bs-btn-hover-border-color: var(--color-primary);
    --bs-btn-active-bg: var(--color-primary);
    --bs-btn-active-border-color: var(--color-primary);
  }

  .btn-outline-primary:hover {
    color: var(--color-text-inverse) !important;
  }

  .btn-primary {
    background: var(--color-primary) !important;
    border-color: var(--color-primary) !important;
    color: var(--color-text-inverse) !important;
  }

  .btn-primary:hover {
    background: var(--color-primary-dark) !important;
    border-color: var(--color-primary-dark) !important;
  }

  .btn-secondary {
    background: var(--color-secondary) !important;
    border-color: var(--color-secondary) !important;
    color: var(--color-text-inverse) !important;
  }

  .btn-secondary:hover {
    background: var(--color-secondary-dark) !important;
    border-color: var(--color-secondary-dark) !important;
  }

  /* ========================================================
   FULLCALENDAR CUSTOMIZATION
   ======================================================== */

  #calendar {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    padding: var(--space-lg);
    min-height: 600px;
  }

  /* FullCalendar header */
  .fc .fc-toolbar-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--color-text-primary);
  }

  .fc .fc-button-primary {
    background-color: var(--color-primary) !important;
    border-color: var(--color-primary) !important;
    color: var(--color-text-inverse) !important;
    font-weight: 500;
  }

  .fc .fc-button-primary:hover {
    background-color: var(--color-primary-dark) !important;
    border-color: var(--color-primary-dark) !important;
  }

  .fc .fc-button-primary:not(:disabled):active,
  .fc .fc-button-primary:not(:disabled).fc-button-active {
    background-color: var(--color-primary-dark) !important;
    border-color: var(--color-primary-dark) !important;
  }

  /* FullCalendar day cells */
  .fc .fc-daygrid-day {
    background: var(--color-surface-elevated);
    transition: background-color var(--transition-fast);
  }

  .fc .fc-daygrid-day:hover {
    background: var(--color-surface);
  }

  .fc .fc-daygrid-day-top {
    color: var(--color-text-primary);
  }

  .fc .fc-day-today {
    background-color: rgba(var(--color-primary-rgb), 0.1) !important;
  }

  .fc .fc-day-today .fc-daygrid-day-number {
    background-color: var(--color-primary);
    color: var(--color-text-inverse);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }

  /* FullCalendar events */
  .fc-event {
    border: none !important;
    border-radius: var(--radius-sm) !important;
    padding: 4px 8px !important;
    margin-bottom: 2px !important;
    cursor: pointer !important;
    transition: all var(--transition-fast) !important;
    font-weight: 500 !important;
  }

  .fc-event:hover {
    transform: translateY(-1px) !important;
    box-shadow: var(--shadow-sm) !important;
    filter: brightness(110%) !important;
  }

  .fc-event-title {
    font-weight: 500 !important;
    font-size: 0.875rem !important;
  }

  /* FullCalendar column headers */
  .fc .fc-col-header-cell {
    background: var(--color-surface-elevated);
    color: var(--color-text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    padding: var(--space-md);
    border-color: var(--color-border);
  }

  /* FullCalendar grid borders */
  .fc .fc-scrollgrid {
    border-color: var(--color-border) !important;
  }

  .fc .fc-daygrid-day,
  .fc .fc-col-header-cell {
    border-color: var(--color-border) !important;
  }

  /* Modal styling */
  .evento-meta-modal {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-md);
    color: var(--color-text-secondary);
    font-size: 0.95rem;
    margin-bottom: var(--space-md);
    padding: var(--space-md);
    background: var(--color-surface-elevated);
    border-radius: var(--radius-md);
  }

  .evento-meta-modal span {
    display: flex;
    align-items: center;
  }

  .evento-meta-modal i {
    margin-right: var(--space-xs);
    color: var(--color-primary);
  }

  .evento-description-modal {
    color: var(--color-text-primary);
    line-height: 1.6;
    margin-bottom: var(--space-lg);
  }

  .evento-image-modal {
    width: 100%;
    max-height: 300px;
    object-fit: cover;
    border-radius: var(--radius-md);
    margin-bottom: var(--space-lg);
    box-shadow: var(--shadow-sm);
  }

  .evento-actions-modal {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    padding: var(--space-md);
    background: var(--color-surface-elevated);
    border-radius: var(--radius-md);
  }

  /* Loading state */
  .fc-loading {
    position: relative;
  }

  .fc-loading::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  /* Responsive */
  @media (max-width: 768px) {
    #calendar {
      padding: var(--space-sm);
    }

    .fc .fc-toolbar {
      flex-direction: column;
      gap: var(--space-md);
    }

    .fc .fc-toolbar-title {
      font-size: 1.25rem;
    }

    .fc .fc-button {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
    }

    .evento-actions-modal {
      flex-direction: column;
    }

    .evento-actions-modal .btn {
      width: 100%;
    }
  }

  /* Animation */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  #calendar {
    animation: fadeIn 0.5s ease-out;
  }
</style>

<!-- FullCalendar CSS -->
<link
  href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css"
  rel="stylesheet"
/>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<!-- FullCalendar Italian Locale -->
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/it.global.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');

    // Configura lingua in base al contesto Django
    const locale = '{{ LANGUAGE_CODE|default:"it" }}';

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: locale,
      firstDay: 1, // Luned√¨ come primo giorno
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,listMonth'
      },
      buttonText: {
        today: '{% trans "Oggi" %}',
        month: '{% trans "Mese" %}',
        week: '{% trans "Settimana" %}',
        list: '{% trans "Lista" %}',
      },
      events: [
        {% for evento in eventi %}
        {
          id: '{{ evento.id }}',
          title: '{{ evento.titolo|escapejs }}',
          start: '{{ evento.data_inizio|date:"Y-m-d\TH:i:s" }}',
          {% if evento.data_fine %}
          end: '{{ evento.data_fine|date:"Y-m-d\TH:i:s" }}',
          {% endif %}
          url: '{{ evento.get_absolute_url }}',
          backgroundColor: '#1976d2',
          borderColor: '#1976d2',
          extendedProps: {
            descrizione: '{{ evento.descrizione|escapejs }}',
            luogo: '{{ evento.luogo|escapejs }}',
            {% if evento.immagine %}
            immagine: '{{ evento.immagine.url }}',
            {% endif %}
            detailUrl: '{{ evento.get_absolute_url }}'
          }
        },
        {% endfor %}
      ],
      eventClick: function(info) {
        info.jsEvent.preventDefault(); // Previeni navigazione diretta

        const evento = info.event;
        const props = evento.extendedProps;

        // Popola il modal
        document.getElementById('eventoModalTitle').innerHTML = `
          <i class="bi bi-calendar-event me-2"></i>${evento.title}
        `;

        let modalContent = '';

        // Immagine
        if (props.immagine) {
          modalContent += `
            <img src="${props.immagine}" alt="${evento.title}" class="evento-image-modal">
          `;
        }

        // Meta informazioni
        modalContent += `
          <div class="evento-meta-modal">
            <span>
              <i class="bi bi-calendar"></i>
              ${evento.start.toLocaleDateString(locale, {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </span>
            <span>
              <i class="bi bi-clock"></i>
              ${evento.start.toLocaleTimeString(locale, {
                hour: '2-digit',
                minute: '2-digit'
              })}
              ${evento.end ? ' - ' + evento.end.toLocaleTimeString(locale, {
                hour: '2-digit',
                minute: '2-digit'
              }) : ''}
            </span>
            <span>
              <i class="bi bi-geo-alt"></i>
              ${props.luogo}
            </span>
          </div>
        `;

        // Descrizione
        if (props.descrizione) {
          modalContent += `
            <div class="evento-description-modal">
              <h6 class="fw-semibold mb-2">{% trans "Descrizione" %}</h6>
              <p>${props.descrizione}</p>
            </div>
          `;
        }

        // Azioni rapide
        modalContent += `
          <div class="evento-actions-modal">
            <h6 class="fw-semibold mb-3 w-100">{% trans "Aggiungi al calendario" %}</h6>
            <button class="btn btn-sm btn-outline-primary" onclick="aggiungiGoogleCalendar('${evento.title.replace(/'/g, "\\'")}', '${props.descrizione.replace(/'/g, "\\'")}', '${evento.start.toISOString().split('T')[0]}', '${evento.start.toTimeString().substring(0,5)}', '${evento.end ? evento.end.toTimeString().substring(0,5) : evento.start.toTimeString().substring(0,5)}', '${props.luogo.replace(/'/g, "\\'")}')">
              <i class="bi bi-google text-danger me-1"></i>{% trans "Google Calendar" %}
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="aggiungiOutlookCalendar('${evento.title.replace(/'/g, "\\'")}', '${props.descrizione.replace(/'/g, "\\'")}', '${evento.start.toISOString().split('T')[0]}', '${evento.start.toTimeString().substring(0,5)}', '${evento.end ? evento.end.toTimeString().substring(0,5) : evento.start.toTimeString().substring(0,5)}', '${props.luogo.replace(/'/g, "\\'")}')">
              <i class="bi bi-microsoft text-primary me-1"></i>{% trans "Outlook" %}
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="aggiungiAppleCalendar('${evento.title.replace(/'/g, "\\'")}', '${props.descrizione.replace(/'/g, "\\'")}', '${evento.start.toISOString().split('T')[0]}', '${evento.start.toTimeString().substring(0,5)}', '${evento.end ? evento.end.toTimeString().substring(0,5) : evento.start.toTimeString().substring(0,5)}', '${props.luogo.replace(/'/g, "\\'")}')">
              <i class="bi bi-apple me-1"></i>{% trans "Apple Calendar" %}
            </button>
            <button class="btn btn-sm btn-warning" onclick="condividiWhatsApp('${evento.title.replace(/'/g, "\\'")}', '${evento.start.toLocaleDateString(locale)}', '${evento.start.toTimeString().substring(0,5)}', '${props.luogo.replace(/'/g, "\\'")}')">
              <i class="bi bi-whatsapp me-1"></i>{% trans "WhatsApp" %}
            </button>
          </div>
        `;

        document.getElementById('eventoModalBody').innerHTML = modalContent;
        document.getElementById('eventoDetailLink').href = props.detailUrl;

        // Mostra il modal
        const modal = new bootstrap.Modal(document.getElementById('eventoModal'));
        modal.show();
      },
      eventDidMount: function(info) {
        // Aggiungi tooltip
        info.el.title = info.event.title;
      },
      height: 'auto',
      contentHeight: 'auto',
      aspectRatio: 1.8,
      expandRows: true,
      navLinks: true,
      editable: false,
      dayMaxEvents: true,
      views: {
        dayGridMonth: {
          dayMaxEvents: 3
        }
      }
    });

    calendar.render();
  });

  // Funzioni per gestire l'aggiunta ai calendari
  function mostraSuccesso(messaggio) {
    const notifica = document.createElement('div');
    notifica.className = 'position-fixed fade show';
    notifica.style.cssText = `
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 320px;
      background: var(--color-success);
      color: var(--color-text-inverse);
      padding: 1rem 1.25rem;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      border: none;
      font-weight: 500;
    `;
    notifica.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="bi bi-check-circle me-2"></i>
        <span>${messaggio}</span>
        <button type="button" class="btn-close btn-close-white ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
      </div>
    `;

    document.body.appendChild(notifica);

    setTimeout(() => {
      notifica.style.transform = 'translateX(0)';
    }, 10);

    setTimeout(() => {
      if (notifica.parentNode) {
        notifica.style.transform = 'translateX(100%)';
        setTimeout(() => notifica.remove(), 300);
      }
    }, 4000);
  }

  function aggiungiGoogleCalendar(titolo, descrizione, data, oraInizio, oraFine, luogo) {
    const dataOraInizio = new Date(`${data}T${oraInizio}`);
    const dataOraFine = new Date(`${data}T${oraFine}`);

    const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(titolo)}&dates=${dataOraInizio.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '')}/${dataOraFine.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '')}&details=${encodeURIComponent(descrizione)}&location=${encodeURIComponent(luogo)}`;

    window.open(googleUrl, '_blank');
    mostraSuccesso("{% trans 'Evento aperto in Google Calendar!' %}");
  }

  function aggiungiOutlookCalendar(titolo, descrizione, data, oraInizio, oraFine, luogo) {
    const dataOraInizio = new Date(`${data}T${oraInizio}`);
    const dataOraFine = new Date(`${data}T${oraFine}`);

    const outlookUrl = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(titolo)}&startdt=${dataOraInizio.toISOString()}&enddt=${dataOraFine.toISOString()}&body=${encodeURIComponent(descrizione)}&location=${encodeURIComponent(luogo)}`;

    window.open(outlookUrl, '_blank');
    mostraSuccesso("{% trans 'Evento aperto in Outlook!' %}");
  }

  function aggiungiAppleCalendar(titolo, descrizione, data, oraInizio, oraFine, luogo) {
    const dataOraInizio = new Date(`${data}T${oraInizio}`);
    const dataOraFine = new Date(`${data}T${oraFine}`);

    const icsContent = `BEGIN:VCALENDAR
  VERSION:2.0
  BEGIN:VEVENT
  SUMMARY:${titolo}
  DESCRIPTION:${descrizione}
  LOCATION:${luogo}
  DTSTART:${dataOraInizio.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '')}
  DTEND:${dataOraFine.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '')}
  END:VEVENT
  END:VCALENDAR`;

    const blob = new Blob([icsContent], { type: 'text/calendar' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'evento.ics';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    mostraSuccesso("{% blocktrans %}File calendario scaricato! Aprilo per aggiungere l'evento.{% endblocktrans %}");
  }

  function condividiWhatsApp(titolo, data, ora, luogo) {
    const messaggio = `üé≠ *${titolo}*\nüìÖ ${data} {% trans 'alle' %} ${ora}\nüìç ${luogo}\n\n{% trans 'Scopri di pi√π sul sito del Parco Letterario del Verismo!' %}`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(messaggio)}`;
    window.open(whatsappUrl, '_blank');
    mostraSuccesso("{% trans 'Evento condiviso su WhatsApp!' %}");
  }
</script>
{% endblock %}
