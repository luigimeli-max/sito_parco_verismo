{% extends "parco_verismo/base.html" %}
{% load static i18n %}

{% block title %}{% trans 'Archivio Fotografico - Parco Letterario Verismo' %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/archivio.css' %}">
{% endblock %}

{% block hero_section %}{% endblock %}

{% block content %}
<section class="archivio-section">
  <div class="container py-5">
    <div class="row">
      <div class="col-12 text-center mb-5">
        <h1 class="archivio-title fade-in-up">{% trans 'Archivio Fotografico' %}</h1>
        <p class="archivio-subtitle fade-in-up">{% trans 'Un viaggio visivo attraverso i luoghi e le storie del Verismo' %}</p>
      </div>
    </div>

    {% if foto_verga or foto_capuana or foto_altro %}
      
      <!-- Sezione Giovanni Verga -->
      {% if foto_verga %}
      <div class="row mb-5">
        <div class="col-12">
          <h2 class="text-center mb-4 section-title">Giovanni Verga</h2>
          <div id="carouselVerga" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="6000" data-bs-pause="hover">
            <div class="carousel-indicators">
              {% for foto_item in foto_verga %}
                <button type="button" data-bs-target="#carouselVerga" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active" aria-current="true"{% endif %} aria-label="Slide {{ forloop.counter }}"></button>
              {% endfor %}
            </div>
            <div class="carousel-inner">
              {% for foto_item in foto_verga %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}" 
                     data-foto-index="{{ forloop.counter0 }}"
                     data-foto-url="{{ foto_item.immagine.url }}"
                     data-foto-titolo="{{ foto_item.titolo|default:'' }}"
                     data-foto-descrizione="{{ foto_item.descrizione|default:'' }}"
                     data-foto-categoria="{{ foto_item.categoria|default:'' }}">
                  <div class="carousel-image-wrapper">
                    <img src="{{ foto_item.immagine.url }}" class="d-block w-100 carousel-image" alt="{{ foto_item.titolo|default:'Foto archivio' }}" data-foto-index="{{ forloop.counter0 }}">
                    <div class="carousel-overlay"></div>
                    <button class="carousel-expand-btn" data-bs-toggle="modal" data-bs-target="#imageModal" data-foto-index="{{ forloop.counter0 }}" title="{% trans 'Visualizza a schermo intero' %}"><i class="bi bi-arrows-fullscreen"></i></button>
                  </div>
                  {% if foto_item.titolo or foto_item.descrizione %}
                    <div class="carousel-caption"><div class="carousel-caption-content">
                        {% if foto_item.categoria %}<span class="carousel-category">{{ foto_item.categoria }}</span>{% endif %}
                        {% if foto_item.titolo %}<h3 class="carousel-title">{{ foto_item.titolo }}</h3>{% endif %}
                        {% if foto_item.descrizione %}<p class="carousel-description">{{ foto_item.descrizione }}</p>{% endif %}
                    </div></div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselVerga" data-bs-slide="prev"><span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">{% trans 'Precedente' %}</span></button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselVerga" data-bs-slide="next"><span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">{% trans 'Successivo' %}</span></button>
          </div>
          
          <div class="archivio-thumbnails mt-4">
            {% for foto_item in foto_verga %}
              <div class="thumbnail-item fade-in-up" data-foto-index="{{ forloop.counter0 }}">
                <div class="thumbnail-wrapper">
                  <img src="{{ foto_item.immagine.url }}" alt="{{ foto_item.titolo|default:'Foto archivio' }}" class="thumbnail-image" data-foto-index="{{ forloop.counter0 }}">
                  <div class="thumbnail-overlay">{% if foto_item.titolo %}<span class="thumbnail-title">{{ foto_item.titolo }}</span>{% endif %}<i class="bi bi-zoom-in thumbnail-icon"></i></div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Sezione Luigi Capuana -->
      {% if foto_capuana %}
      <div class="row mb-5">
        <div class="col-12">
          <h2 class="text-center mb-4 section-title">Luigi Capuana</h2>
          <div id="carouselCapuana" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="6000" data-bs-pause="hover">
            <div class="carousel-indicators">
              {% for foto_item in foto_capuana %}
                <button type="button" data-bs-target="#carouselCapuana" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active" aria-current="true"{% endif %} aria-label="Slide {{ forloop.counter }}"></button>
              {% endfor %}
            </div>
            <div class="carousel-inner">
              {% for foto_item in foto_capuana %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}" 
                     data-foto-index="{{ forloop.counter0|add:foto_verga.count }}"
                     data-foto-url="{{ foto_item.immagine.url }}"
                     data-foto-titolo="{{ foto_item.titolo|default:'' }}"
                     data-foto-descrizione="{{ foto_item.descrizione|default:'' }}"
                     data-foto-categoria="{{ foto_item.categoria|default:'' }}">
                  <div class="carousel-image-wrapper">
                    <img src="{{ foto_item.immagine.url }}" class="d-block w-100 carousel-image" alt="{{ foto_item.titolo|default:'Foto archivio' }}" data-foto-index="{{ forloop.counter0|add:foto_verga.count }}">
                    <div class="carousel-overlay"></div>
                    <button class="carousel-expand-btn" data-bs-toggle="modal" data-bs-target="#imageModal" data-foto-index="{{ forloop.counter0|add:foto_verga.count }}" title="{% trans 'Visualizza a schermo intero' %}"><i class="bi bi-arrows-fullscreen"></i></button>
                  </div>
                  {% if foto_item.titolo or foto_item.descrizione %}
                    <div class="carousel-caption"><div class="carousel-caption-content">
                        {% if foto_item.categoria %}<span class="carousel-category">{{ foto_item.categoria }}</span>{% endif %}
                        {% if foto_item.titolo %}<h3 class="carousel-title">{{ foto_item.titolo }}</h3>{% endif %}
                        {% if foto_item.descrizione %}<p class="carousel-description">{{ foto_item.descrizione }}</p>{% endif %}
                    </div></div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselCapuana" data-bs-slide="prev"><span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">{% trans 'Precedente' %}</span></button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselCapuana" data-bs-slide="next"><span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">{% trans 'Successivo' %}</span></button>
          </div>
          
          <div class="archivio-thumbnails mt-4">
            {% for foto_item in foto_capuana %}
              <div class="thumbnail-item fade-in-up" data-foto-index="{{ forloop.counter0|add:foto_verga.count }}">
                <div class="thumbnail-wrapper">
                  <img src="{{ foto_item.immagine.url }}" alt="{{ foto_item.titolo|default:'Foto archivio' }}" class="thumbnail-image" data-foto-index="{{ forloop.counter0|add:foto_verga.count }}">
                  <div class="thumbnail-overlay">{% if foto_item.titolo %}<span class="thumbnail-title">{{ foto_item.titolo }}</span>{% endif %}<i class="bi bi-zoom-in thumbnail-icon"></i></div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Sezione Altro -->
      {% if foto_altro %}
      <div class="row mb-5">
        <div class="col-12">
          <h2 class="text-center mb-4 section-title">Altro</h2>
          <div id="carouselAltro" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="6000" data-bs-pause="hover">
            <div class="carousel-indicators">
              {% for foto_item in foto_altro %}
                <button type="button" data-bs-target="#carouselAltro" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active" aria-current="true"{% endif %} aria-label="Slide {{ forloop.counter }}"></button>
              {% endfor %}
            </div>
            <div class="carousel-inner">
              {% for foto_item in foto_altro %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}" 
                     data-foto-index="{{ forloop.counter0|add:foto_verga.count|add:foto_capuana.count }}"
                     data-foto-url="{{ foto_item.immagine.url }}"
                     data-foto-titolo="{{ foto_item.titolo|default:'' }}"
                     data-foto-descrizione="{{ foto_item.descrizione|default:'' }}"
                     data-foto-categoria="{{ foto_item.categoria|default:'' }}">
                  <div class="carousel-image-wrapper">
                    <img src="{{ foto_item.immagine.url }}" class="d-block w-100 carousel-image" alt="{{ foto_item.titolo|default:'Foto archivio' }}" data-foto-index="{{ forloop.counter0|add:foto_verga.count|add:foto_capuana.count }}">
                    <div class="carousel-overlay"></div>
                    <button class="carousel-expand-btn" data-bs-toggle="modal" data-bs-target="#imageModal" data-foto-index="{{ forloop.counter0|add:foto_verga.count|add:foto_capuana.count }}" title="{% trans 'Visualizza a schermo intero' %}"><i class="bi bi-arrows-fullscreen"></i></button>
                  </div>
                  {% if foto_item.titolo or foto_item.descrizione %}
                    <div class="carousel-caption"><div class="carousel-caption-content">
                        {% if foto_item.categoria %}<span class="carousel-category">{{ foto_item.categoria }}</span>{% endif %}
                        {% if foto_item.titolo %}<h3 class="carousel-title">{{ foto_item.titolo }}</h3>{% endif %}
                        {% if foto_item.descrizione %}<p class="carousel-description">{{ foto_item.descrizione }}</p>{% endif %}
                    </div></div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselAltro" data-bs-slide="prev"><span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">{% trans 'Precedente' %}</span></button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselAltro" data-bs-slide="next"><span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">{% trans 'Successivo' %}</span></button>
          </div>
          
          <div class="archivio-thumbnails mt-4">
            {% for foto_item in foto_altro %}
              <div class="thumbnail-item fade-in-up" data-foto-index="{{ forloop.counter0|add:foto_verga.count|add:foto_capuana.count }}">
                <div class="thumbnail-wrapper">
                  <img src="{{ foto_item.immagine.url }}" alt="{{ foto_item.titolo|default:'Foto archivio' }}" class="thumbnail-image" data-foto-index="{{ forloop.counter0|add:foto_verga.count|add:foto_capuana.count }}">
                  <div class="thumbnail-overlay">{% if foto_item.titolo %}<span class="thumbnail-title">{{ foto_item.titolo }}</span>{% endif %}<i class="bi bi-zoom-in thumbnail-icon"></i></div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

    {% else %}
      <div class="row">
        <div class="col-12">
          <div class="alert alert-info text-center">
            <h5>{% trans 'Nessuna foto disponibile' %}</h5>
            <p>{% trans "L'archivio fotografico sar√† presto disponibile." %}</p>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</section>

<!-- Modal per visualizzazione a schermo intero -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="imageModalLabel"></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="{% trans 'Chiudi' %}"></button>
      </div>
      <div class="modal-body p-0 d-flex align-items-center justify-content-center position-relative">
        <button class="modal-nav-btn modal-nav-prev" id="modalPrevBtn" aria-label="{% trans 'Precedente' %}">
          <i class="bi bi-chevron-left"></i>
        </button>
        <img id="modalImage" src="" alt="" class="modal-full-image">
        <button class="modal-nav-btn modal-nav-next" id="modalNextBtn" aria-label="{% trans 'Successivo' %}">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <div class="modal-image-info text-center">
          <h6 id="modalImageTitle" class="mb-2"></h6>
          <p id="modalImageDescription" class="text-muted mb-0 small"></p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Animazione fade-in al caricamento
  document.addEventListener('DOMContentLoaded', function() {
    const elements = document.querySelectorAll('.fade-in-up');
    elements.forEach((el, index) => {
      setTimeout(() => {
        el.style.opacity = '1';
        el.style.transform = 'translateY(0)';
      }, index * 100);
    });
  });

  // Inizializza il carosello con autoplay
  const carousel = document.getElementById('archivioCarousel');
  if (carousel) {
    const carouselInstance = new bootstrap.Carousel(carousel, {
      interval: 6000,
      ride: 'carousel',
      pause: 'hover',
      wrap: true
    });

    // Animazione al cambio slide
    carousel.addEventListener('slide.bs.carousel', function (e) {
      const activeItem = e.relatedTarget;
      const caption = activeItem.querySelector('.carousel-caption-content');
      const image = activeItem.querySelector('.carousel-image');
      
      if (caption) {
        caption.style.opacity = '0';
        caption.style.transform = 'translateY(20px)';
      }
      
      // Reset animazione zoom
      if (image) {
        image.style.animation = 'none';
      }
    });

    carousel.addEventListener('slid.bs.carousel', function (e) {
      const activeItem = e.relatedTarget;
      const caption = activeItem.querySelector('.carousel-caption-content');
      const image = activeItem.querySelector('.carousel-image');
      
      if (caption) {
        setTimeout(() => {
          caption.style.opacity = '1';
          caption.style.transform = 'translateY(0)';
        }, 100);
      }
      
      // Riavvia animazione zoom
      if (image) {
        setTimeout(() => {
          image.style.animation = 'imageZoom 6s ease-in-out infinite';
        }, 50);
      }
    });
  }

  // Gestione modal per visualizzazione a schermo intero
  const imageModal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  const modalImageTitle = document.getElementById('modalImageTitle');
  const modalImageDescription = document.getElementById('modalImageDescription');
  const modalImageLabel = document.getElementById('imageModalLabel');
  const modalPrevBtn = document.getElementById('modalPrevBtn');
  const modalNextBtn = document.getElementById('modalNextBtn');
  
  let currentFotoIndex = 0;
  const fotoItems = document.querySelectorAll('.carousel-item');
  const totalFotos = fotoItems.length;

  // Funzione per aprire il modal con una foto specifica
  function openImageModal(index) {
    const fotoItem = fotoItems[index];
    if (!fotoItem) return;

    const fotoUrl = fotoItem.getAttribute('data-foto-url');
    const fotoTitolo = fotoItem.getAttribute('data-foto-titolo') || '';
    const fotoDescrizione = fotoItem.getAttribute('data-foto-descrizione') || '';
    const fotoCategoria = fotoItem.getAttribute('data-foto-categoria') || '';

    modalImage.src = fotoUrl;
    modalImage.alt = fotoTitolo || 'Foto archivio';
    modalImageTitle.textContent = fotoTitolo;
    modalImageDescription.textContent = fotoDescrizione;
    modalImageLabel.textContent = fotoCategoria ? `${fotoCategoria} - ${fotoTitolo}` : fotoTitolo;
    
    currentFotoIndex = index;
    updateModalNavigation();
  }

  // Funzione per aggiornare la navigazione del modal
  function updateModalNavigation() {
    modalPrevBtn.style.display = totalFotos > 1 ? 'flex' : 'none';
    modalNextBtn.style.display = totalFotos > 1 ? 'flex' : 'none';
  }

  // Event listener per aprire il modal dal pulsante expand
  document.querySelectorAll('.carousel-expand-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const index = parseInt(this.getAttribute('data-foto-index'));
      if (!isNaN(index)) {
        openImageModal(index);
        bootstrap.Modal.getOrCreateInstance(imageModal).show();
      }
    });
  });

  // Click su thumbnail per aprire il modal
  document.querySelectorAll('.thumbnail-item').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const index = parseInt(this.getAttribute('data-foto-index'));
      if (!isNaN(index)) {
        openImageModal(index);
        bootstrap.Modal.getOrCreateInstance(imageModal).show();
      }
    });
  });

  // Click sull'immagine del carosello per aprire il modal
  document.querySelectorAll('.carousel-image').forEach(img => {
    img.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const index = parseInt(this.getAttribute('data-foto-index'));
      if (!isNaN(index)) {
        openImageModal(index);
        bootstrap.Modal.getOrCreateInstance(imageModal).show();
      }
    });
  });

  // Navigazione nel modal
  modalPrevBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    currentFotoIndex = (currentFotoIndex - 1 + totalFotos) % totalFotos;
    openImageModal(currentFotoIndex);
  });

  modalNextBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    currentFotoIndex = (currentFotoIndex + 1) % totalFotos;
    openImageModal(currentFotoIndex);
  });

  // Navigazione con tastiera
  imageModal.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      modalPrevBtn.click();
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      modalNextBtn.click();
    } else if (e.key === 'Escape') {
      const modalInstance = bootstrap.Modal.getInstance(imageModal);
      if (modalInstance) {
        modalInstance.hide();
      }
    }
  });
</script>
{% endblock %}


